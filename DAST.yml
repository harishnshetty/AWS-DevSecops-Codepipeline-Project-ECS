version: 0.2

env:
  secrets-manager:
    ZAP_API_KEY: dev/zap:apikey   # your secret/key
  variables:
    ZAP_HOST: "10.0.7.152"
    ZAP_PORT: "8080"
    TARGET_URL: "https://staging.harishshetty.xyz/"

phases:
  install:
    commands:
      - yum install -y jq curl

  build:
    commands:
      - |
        set -e
        ZAP_URL="http://$ZAP_HOST:$ZAP_PORT"
        TARGET="$TARGET_URL"
        API_KEY="$ZAP_API_KEY"

        echo "ZAP_URL = $ZAP_URL"
        echo "TARGET  = $TARGET"

        echo "=== 1) New session ==="
        curl -s "$ZAP_URL/JSON/core/action/newSession/?apikey=$API_KEY&name=codebuild_dast&overwrite=true" > /tmp/zap_newsession.json || true
        cat /tmp/zap_newsession.json || true

        echo "=== 2) Spider ==="
        SPIDER_ID=$(curl -s "$ZAP_URL/JSON/spider/action/scan/?apikey=$API_KEY&url=$TARGET&recurse=true" | jq -r '.scan')
        echo "Spider id: $SPIDER_ID"

        while true; do
          STATUS=$(curl -s "$ZAP_URL/JSON/spider/view/status/?apikey=$API_KEY&scanId=$SPIDER_ID" | jq -r '.status')
          echo "Spider progress: $STATUS%"
          if [ "$STATUS" -ge 100 ]; then
            break
          fi
          sleep 5
        done

        echo "Spider done, sleeping 5s..."
        sleep 5

        echo "=== 3) Active Scan ==="
        SCAN_ID=$(curl -s "$ZAP_URL/JSON/ascan/action/scan/?apikey=$API_KEY&url=$TARGET&recurse=true&inScopeOnly=false" | jq -r '.scan')
        echo "Scan id: $SCAN_ID"

        while true; do
          STATUS=$(curl -s "$ZAP_URL/JSON/ascan/view/status/?apikey=$API_KEY&scanId=$SCAN_ID" | jq -r '.status')
          echo "Active scan progress: $STATUS%"
          if [ "$STATUS" -ge 100 ]; then
            break
          fi
          sleep 10
        done

        echo "=== 4) Reports ==="
        curl -s "$ZAP_URL/OTHER/core/other/htmlreport/?apikey=$API_KEY" > zap_report.html
        curl -s "$ZAP_URL/JSON/core/view/alerts/?apikey=$API_KEY&baseurl=$TARGET" > zap_report.json

artifacts:
  files:
    - zap_report.html
    - zap_report.json
